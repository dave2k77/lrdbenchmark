name: Test PyPI Publishing

on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches: [master]
    paths: ['pyproject.toml', 'lrdbenchmark/__init__.py']  # Only on version changes

jobs:
  test-publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        
    - name: Build package
      run: python -m build
      
    - name: Check package
      run: |
        echo "ğŸ“¦ Built packages:"
        ls -la dist/
        echo "ğŸ” Package validation:"
        twine check dist/*
        
    - name: Test upload (dry run)
      run: |
        echo "ğŸ§ª Testing upload (dry run)..."
        twine check dist/*
        echo "âœ… Package validation passed!"
        
    - name: Debug trusted publishing
      run: |
        echo "ğŸ” Trusted Publishing Debug:"
        echo "Repository: ${{ github.repository }}"
        echo "Ref: ${{ github.ref }}"
        echo "Event: ${{ github.event_name }}"
        echo "Actor: ${{ github.actor }}"
        echo "Workflow: ${{ github.workflow }}"
        
    - name: Upload to TestPyPI (if manual trigger)
      if: github.event_name == 'workflow_dispatch'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        echo "ğŸ§ª Uploading to TestPyPI for testing..."
        twine upload --repository testpypi dist/*
        echo "âœ… Uploaded to TestPyPI!"